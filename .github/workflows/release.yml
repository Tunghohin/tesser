name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version bump type (patch, minor, major)
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare-release:
    name: Prepare release artifacts
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      changelog: ${{ steps.changelog.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install release tooling
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release, git-cliff

      - name: Configure Git author
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Run cargo release
        run: cargo release ${{ github.event.inputs.version }} --execute --no-publish

      - name: Determine tag name
        id: tag
        run: |
          TAG=$(git describe --tags --abbrev=0)
          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "Detected tag: $TAG"

      - name: Generate release notes
        id: changelog
        run: |
          git-cliff --latest --strip all > RELEASE_NOTES.md
          {
            echo 'body<<EOF'
            cat RELEASE_NOTES.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Push release commit and tag
        run: git push origin HEAD --follow-tags

  build-and-upload:
    name: Build and upload binaries
    runs-on: ${{ matrix.os }}
    needs: prepare-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag_name }}

      - name: Install musl-tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build tesser-cli
        run: cargo build --package tesser-cli --release --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          set -euo pipefail
          CLI_NAME="tesser-cli"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            CLI_NAME="tesser-cli.exe"
          fi
          
          ARTIFACT_NAME="tesser-cli-${{ needs.prepare-release.outputs.tag_name }}-${{ matrix.target }}"
          mkdir -p "$ARTIFACT_NAME"
          cp "target/${{ matrix.target }}/release/${CLI_NAME}" "$ARTIFACT_NAME/"
          
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            ARCHIVE_PATH="${ARTIFACT_NAME}.zip"
            7z a "$ARCHIVE_PATH" "./$ARTIFACT_NAME/*" >/dev/null
          else
            ARCHIVE_PATH="${ARTIFACT_NAME}.tar.gz"
            tar -czf "$ARCHIVE_PATH" -C "$ARTIFACT_NAME" .
          fi
          
          echo "ASSET_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: ${{ needs.prepare-release.outputs.tag_name }}
          body: ${{ needs.prepare-release.outputs.changelog }}
          files: ${{ env.ASSET_PATH }}
          draft: true
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish crates.io packages
    runs-on: ubuntu-latest
    needs: prepare-release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag_name }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Compute publish order
        id: publish_order
        run: |
          ORDER=$(python .github/scripts/compute_publish_order.py)
          {
            echo 'crates<<EOF'
            echo "$ORDER"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${CARGO_REGISTRY_TOKEN:-}" ]; then
            echo "::error::CRATES_IO_TOKEN secret is not configured."
            exit 1
          fi
          while IFS= read -r crate; do
            [ -z "$crate" ] && continue
            echo "::group::Publishing $crate"
            cargo publish -p "$crate"
            echo "::endgroup::"
            sleep 30
          done <<< "${{ steps.publish_order.outputs.crates }}"

  publish-release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs:
      - build-and-upload
      - publish-crates
      - prepare-release
    permissions:
      contents: write
    steps:
      - name: Make release public
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}
